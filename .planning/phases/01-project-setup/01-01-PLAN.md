---
phase: 01-project-setup
plan: 01
type: execute
depends_on: []
files_modified: [next/package.json, next/tsconfig.json, next/app/api/interactions/route.ts, next/lib/discord/verify.ts]
---

<objective>
Working Next.js project with a Discord interactions endpoint that verifies ed25519 signatures and responds to PING/PONG.

Purpose: Establish the serverless foundation that all commands will be routed through. This is the core architectural change from gateway bot to HTTP interactions.
Output: Deployable Next.js app with `/api/interactions` endpoint that Discord can validate.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup/01-RESEARCH.md

# Existing source (reference implementation — do not modify):
@src/types.ts
@src/deploy-commands.ts
@package.json
@.env.example

**Constraints from PROJECT.md:**
- Separate Vercel project (not inside existing website)
- Next.js for project structure
- Node.js runtime (NOT Edge — firebase-admin requires Node.js APIs)
- Feature parity with existing bot

**From RESEARCH.md:**
- Use `discord-verify` for ed25519 verification (WebCrypto-based)
- Use `discord-api-types` for TypeScript types/enums
- Do NOT use discord.js — overkill for interactions-only bot
- Use `req.text()` for raw body before signature verification, then `JSON.parse()`
- Handle PING/PONG (Discord validates endpoint with this)
- Node.js runtime required (firebase-admin in later phases)

**Don't hand-roll:**
- Ed25519 verification → use discord-verify
- Interaction types → use discord-api-types enums
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js project</name>
  <files>next/package.json, next/tsconfig.json, next/next.config.ts, next/.env.example, next/.gitignore</files>
  <action>
Create Next.js project in `next/` subdirectory (the existing `src/` is the old gateway bot — keep it untouched).

1. Run `npx create-next-app@latest next --typescript --app --no-tailwind --no-eslint --no-src-dir --import-alias "@/*"` — accept defaults. No Turbopack needed.
2. Install dependencies: `cd next && npm install discord-verify discord-api-types`
3. Clean up scaffolded files: Remove default page content from `app/page.tsx` (replace with simple "Urenlogger API" text), remove `app/globals.css` and `app/layout.tsx` font imports (this is an API-only app, no frontend needed).
4. Create `next/.env.example` with the vars needed for Discord interactions:
   ```
   DISCORD_PUBLIC_KEY=your_discord_public_key_here
   DISCORD_APPLICATION_ID=your_application_id_here
   DISCORD_BOT_TOKEN=your_bot_token_here
   GUILD_ID=your_guild_id_here
   ```
5. Create `next/.env.local` stub (gitignored) referencing .env.example.
6. Verify `next/.gitignore` includes `.env.local` (create-next-app should handle this).

Do NOT install firebase-admin, nodemailer, date-fns, or other dependencies yet — those come in Phase 2.
Do NOT modify anything in the root `src/` directory.
  </action>
  <verify>cd next && npm run build — completes without errors</verify>
  <done>Next.js project builds successfully in next/ directory with discord-verify and discord-api-types installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Discord interactions endpoint with signature verification</name>
  <files>next/app/api/interactions/route.ts, next/lib/discord/verify.ts</files>
  <action>
Create the interactions endpoint following the patterns from 01-RESEARCH.md.

1. Create `next/lib/discord/verify.ts`:
   - Import `isValidRequest` from `discord-verify/node` and `subtle` from `node:crypto`
   - Export `verifyDiscordRequest(rawBody, signature, timestamp)` function
   - Read `DISCORD_PUBLIC_KEY` from `process.env`
   - Return false if signature or timestamp is null/undefined

2. Create `next/app/api/interactions/route.ts`:
   - POST handler only (no GET/PUT/DELETE)
   - Read raw body with `await req.text()` FIRST (before any parsing — body can only be consumed once)
   - Extract `x-signature-ed25519` and `x-signature-timestamp` headers
   - Verify signature via verifyDiscordRequest — return 401 if invalid
   - Parse body with `JSON.parse(rawBody)` AFTER verification
   - Handle `InteractionType.Ping` → respond with `InteractionResponseType.Pong`
   - Handle `InteractionType.ApplicationCommand` → respond with placeholder "Command received" (ephemeral, flags: 64)
   - Return 400 for unknown interaction types
   - Use `InteractionType` and `InteractionResponseType` enums from `discord-api-types/v10`

Important:
- Do NOT use Edge runtime. Omit runtime export or explicitly set `export const runtime = 'nodejs'` — firebase-admin (Phase 2) requires Node.js
- Do NOT use `req.json()` — that consumes the body and makes signature verification impossible
- Ephemeral flag is `64` (MessageFlags.Ephemeral from discord-api-types)
  </action>
  <verify>cd next && npx tsc --noEmit — no TypeScript errors</verify>
  <done>POST /api/interactions endpoint exists with signature verification, PING/PONG handler, and placeholder command response. TypeScript compiles clean.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Discord interactions endpoint at next/app/api/interactions/route.ts with ed25519 signature verification and PING/PONG response</what-built>
  <how-to-verify>
    1. Run: `cd next && npm run dev`
    2. Go to Discord Developer Portal → your application → General Information
    3. Copy the "Public Key" and add it to `next/.env.local` as `DISCORD_PUBLIC_KEY`
    4. Also add `DISCORD_APPLICATION_ID` (Application ID from same page)
    5. The dev server needs to be publicly accessible for Discord to validate. Either:
       a. Deploy to Vercel: `cd next && npx vercel` (follow prompts), OR
       b. Use ngrok: `ngrok http 3000` and use the https URL
    6. In Discord Developer Portal → General Information → "Interactions Endpoint URL":
       Set to `https://your-url/api/interactions`
    7. Click "Save Changes" — Discord will send a PING to your endpoint
    8. Confirm: Discord saves successfully (shows green checkmark / no error)
       If it fails: Check Vercel/ngrok logs for 401 errors (signature verification issue)
  </how-to-verify>
  <resume-signal>Type "approved" if Discord accepted the endpoint, or describe any errors</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd next && npm run build` succeeds without errors
- [ ] `cd next && npx tsc --noEmit` passes
- [ ] Discord Developer Portal accepted the interactions endpoint URL
- [ ] PING/PONG validation succeeded
</verification>

<success_criteria>

- Next.js project scaffolded in next/ with discord-verify and discord-api-types
- Interactions endpoint verifies ed25519 signatures correctly
- PING/PONG handler works (Discord accepts the endpoint)
- Existing src/ code untouched
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup/01-01-SUMMARY.md`
</output>
