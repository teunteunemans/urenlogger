---
phase: 02-command-migration
plan: 02
type: execute
depends_on: ["02-01"]
files_modified:
  - next/lib/discord/commands.ts
  - next/lib/utils/email.ts
domain: next-js
---

<objective>
Port all 6 slash commands and email utility to the Next.js interactions endpoint.

Purpose: Complete command migration so all existing bot functionality works through the HTTP interactions endpoint.
Output: All 6 commands (registreer, log, wijzig, verwijder, uren, email) working via deferred reply pattern, plus email report utility ready for Phase 3 cron.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-command-migration/02-01-SUMMARY.md

# Source files to port FROM (reference implementation):
@src/commands/registreer.ts
@src/commands/log.ts
@src/commands/wijzig.ts
@src/commands/verwijder.ts
@src/commands/uren.ts
@src/commands/email.ts
@src/utils/email.ts

# Already ported modules (from Plan 02-01):
@next/lib/discord/commands.ts
@next/lib/firebase/service.ts
@next/lib/utils/dateParser.ts
@next/lib/i18n/nl.ts
@next/lib/config/constants.ts
@next/lib/types.ts
@next/app/api/interactions/route.ts

**Tech stack available:** Next.js 15, discord-verify, discord-api-types, firebase-admin, date-fns, nodemailer
**Established patterns:**
- Deferred reply pattern from 02-01 (respond with DEFERRED, then PATCH via REST API)
- Firebase service with base64 service account
- @/ import aliases
**Constraining decisions:**
- Phase 01: verify() for signature verification
- Phase 02-01: Deferred reply + REST API PATCH pattern for command responses
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port all 6 commands</name>
  <files>next/lib/discord/commands.ts</files>
  <action>
Replace the placeholder command handlers in next/lib/discord/commands.ts with actual implementations ported from src/commands/*.ts.

**Key adaptation for all commands:** The discord.js interaction object (ChatInputCommandInteraction) is NOT available. Instead, you receive an APIApplicationCommandInteraction from discord-api-types. Differences:
- Options are in `interaction.data.options` array (not .getNumber()/.getString())
- Create helper to extract options: `getOption(interaction, name)` that searches the options array
- For subcommands (email): options are nested under `interaction.data.options[0].options`
- User ID is `interaction.member?.user.id ?? interaction.user?.id` (guild vs DM context)
- No `interaction.deferReply()` or `interaction.editReply()` — the deferred reply is handled by the dispatch infrastructure from 02-01. Each handler just returns a string (the message content).
- For multi-message responses (uren command's splitMessage): return joined string. Discord REST API PATCH replaces the deferred message. If content exceeds 2000 chars, use followUp endpoint: POST to `/webhooks/{app_id}/{token}` (not PATCH to @original).

**Port each command:**

1. **registreer** (simplest):
   - Get "naam" option string
   - Check if user exists with getUser()
   - If exists: updateUserName(), return messages.registreer.updated
   - If new: registerUser(), return messages.registreer.success

2. **email** (subcommand pattern):
   - Detect subcommand from options[0].name ("set", "remove", "show")
   - set: validate email with regex, updateUserEmail()
   - remove: removeUserEmail()
   - show: getUser() and display email or "none"
   - Each returns appropriate i18n message

3. **verwijder** (simple with date):
   - Get "datum" option, parse with parseDateStringWithError()
   - Get user, check registration
   - Find existing logs with getHoursByUserAndDay()
   - Delete with deleteHoursForDay()
   - Return success message with deleted hours info

4. **log** (date + validation):
   - Get "uren" (number), "omschrijving" (optional string), "datum" (optional string, defaults today)
   - Parse date, validate not future
   - Check for duplicate logs on same day (warn but still log)
   - logHours() with registered name from user doc
   - Return success message with formatted date

5. **wijzig** (update pattern):
   - Get "uren" (number), "datum" (string), "omschrijving" (optional)
   - Parse date, find existing logs
   - updateHoursForDay() with new values
   - Return success showing old vs new

6. **uren** (complex output):
   - Get optional "maand" string
   - If maand: parseMonthString() for date range; else: getCurrentBillingPeriod()
   - Fetch hours with getHoursByUser()
   - Aggregate and format entries with Dutch dates
   - Handle long messages with splitMessage() logic
   - For messages exceeding Discord limit: return first chunk, send additional chunks via followUp POST endpoint

**Error handling for all commands:**
- Wrap each handler in try-catch
- On error: return messages.errors.generic or command-specific error message
- Check user registration at start (except registreer which creates users)

**Helper functions to create:**
- `getStringOption(interaction, name): string | null`
- `getNumberOption(interaction, name): number | null`
- `getSubcommand(interaction): string | null`
- `getSubcommandOption(interaction, name): string | null`
- `editReply(token: string, content: string): Promise<void>` — PATCH /webhooks/{app_id}/{token}/messages/@original (reuse from 02-01 dispatch)
- `followUp(token: string, content: string): Promise<void>` — POST /webhooks/{app_id}/{token} with ephemeral flag

Avoid re-implementing date parsing or Firebase logic — use the already-ported modules from 02-01.
  </action>
  <verify>cd next && npm run build succeeds without TypeScript errors. All 6 command handlers registered in commands map.</verify>
  <done>All 6 commands ported with correct option extraction, Firebase calls, date parsing, i18n messages, and error handling. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Port email report utility</name>
  <files>next/lib/utils/email.ts</files>
  <action>
Port src/utils/email.ts to next/lib/utils/email.ts, adapting imports:

1. **createTransporter()** — Same nodemailer SMTP setup. Use SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS from process.env. Same secure/TLS logic.

2. **generatePlainTextReport(report)** — Copy as-is, update imports to @/lib/types.

3. **generateHtmlReport(report)** — Copy as-is, update imports to @/lib/types. This is ~175 lines of HTML template — port faithfully without changing the formatting.

4. **aggregateHoursByUser(logs)** — Copy as-is, update imports.

5. **sendMonthlyReport(startDateString, endDateString, startDate, endDate)** — Port with these changes:
   - Update imports to use @/lib/firebase/service and @/lib/types
   - Remove Discord log channel notification (no discord.js client available — Phase 3 may add this via REST API if needed)
   - Keep BOSS_EMAIL and CC logic

6. **sendTestEmail()** — Port similarly, remove Discord channel notification.

Avoid: Do NOT add the Discord log channel notification here — that requires the bot token REST call which is Phase 3 scope. Just log success/failure to console.
  </action>
  <verify>cd next && npm run build succeeds. Email utility exports all functions with correct types.</verify>
  <done>Email report utility ported with nodemailer, HTML/text report generation, and send functions. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All 6 Discord slash commands ported to HTTP interactions endpoint with deferred reply pattern, plus email report utility</what-built>
  <how-to-verify>
    1. Ensure your .env.local in next/ has all required env vars (Discord + Firebase + SMTP)
    2. Run: cd next && npm run dev
    3. Test in Discord — try each command:
       - /registreer naam:TestNaam — should register or update
       - /log uren:2 omschrijving:test — should log hours for today
       - /uren — should show current billing period hours
       - /wijzig uren:3 datum:vandaag — should update today's hours
       - /verwijder datum:vandaag — should delete today's hours
       - /email show — should show email status
    4. Verify all responses are ephemeral (only visible to you)
    5. Verify Dutch messages appear correctly
    6. Verify error handling (try /log without being registered first, try invalid dates)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd next && npm run build` succeeds without errors
- [ ] All 6 commands respond correctly in Discord
- [ ] Deferred reply pattern works (initial "thinking..." then actual response)
- [ ] Firebase reads/writes work (registreer creates user, log creates entry)
- [ ] Date parsing works with Dutch input ("vandaag", "gisteren", "22 okt")
- [ ] Email subcommands work (set, remove, show)
- [ ] Error handling returns Dutch error messages
- [ ] Long uren output splits correctly across messages
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- All 6 commands functional via Discord interactions endpoint
- Email utility ready for Phase 3 cron integration
- No TypeScript errors
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-command-migration/02-02-SUMMARY.md`
</output>
