---
phase: 03-cron-and-deployment
plan: 01
type: execute
depends_on: []
files_modified:
  - next/app/api/cron/monthly-report/route.ts
  - next/vercel.json
  - next/scripts/deploy-commands.ts
  - next/package.json
  - next/lib/utils/email.ts
domain: next-js
---

<objective>
Vercel Cron Job for monthly report, command registration script, and deployment config.

Purpose: Complete the migration so the Next.js app is fully operational on Vercel — monthly reports fire automatically, slash commands are registered, and Discord gets notified on cron success/failure.
Output: Working Vercel Cron Job route, vercel.json with cron config, and a standalone command registration script.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-command-migration/02-01-SUMMARY.md

# Source files to reference (existing bot implementation):
@src/index.ts
@src/deploy-commands.ts

# Already ported modules in Next.js:
@next/lib/utils/email.ts
@next/lib/firebase/service.ts
@next/lib/config/constants.ts
@next/lib/types.ts
@next/lib/discord/commands.ts
@next/package.json
@next/.env.example

**Tech stack available:** Next.js 16, firebase-admin, date-fns, nodemailer, discord-api-types
**Established patterns:**
- Deferred reply pattern (DeferredChannelMessageWithSource + REST API PATCH)
- Firebase base64 init (Buffer.from(env, 'base64') -> JSON.parse)
- Command handler type: (interaction) => Promise<string>
- @/ import aliases for all next/lib/ modules
**Constraining decisions:**
- Phase 01: Node.js runtime for all API routes (firebase-admin requirement)
- Phase 02-01: Fire-and-forget void IIFE for async command execution after deferred response
- Phase 02-02: Used APIChatInputApplicationCommandInteraction for handler types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vercel Cron Job route and vercel.json</name>
  <files>next/app/api/cron/monthly-report/route.ts, next/vercel.json</files>
  <action>
1. **next/app/api/cron/monthly-report/route.ts** — Create a GET route handler that:
   - Verifies the request is from Vercel Cron by checking `Authorization` header against `CRON_SECRET` env var. Return 401 if missing/invalid. This prevents external callers from triggering the cron.
   - Calculates billing period dates: 22nd of last month → 21st of this month (same logic as src/index.ts lines 101-112). Use BILLING_PERIOD from @/lib/config/constants and date-fns format() for date strings (format: "yyyy-MM-dd").
   - Calls sendMonthlyReport(startDateString, endDateString, startDate, endDate) from @/lib/utils/email.
   - Posts success/failure notification to Discord log channel via REST API (if LOG_CHANNEL_ID is set):
     - Success: POST to `https://discord.com/api/v10/channels/${LOG_CHANNEL_ID}/messages` with body `{content: "Maandrapport voor **${start}** t/m **${end}** succesvol verstuurd naar ${BOSS_EMAIL}"}` and Authorization: `Bot ${DISCORD_BOT_TOKEN}`
     - Failure: Same endpoint with error message
   - Returns 200 JSON `{success: true, period: {start, end}}` on success
   - Returns 500 JSON `{success: false, error: message}` on failure
   - Set `export const runtime = "nodejs"` (firebase-admin requires Node.js runtime)
   - Set `export const maxDuration = 60` (monthly report may take time for large datasets)

2. **next/vercel.json** — Create Vercel config with cron schedule:
   ```json
   {
     "crons": [
       {
         "path": "/api/cron/monthly-report",
         "schedule": "0 0 21 * *"
       }
     ]
   }
   ```
   This fires at 00:00 UTC on the 21st of every month (same as existing bot).

3. **next/.env.example** — Add CRON_SECRET env var to the example file.
  </action>
  <verify>cd next && npm run build succeeds. The cron route compiles. vercel.json is valid JSON.</verify>
  <done>Cron route handles monthly report with billing period calculation, Discord notification, and auth check. vercel.json configures cron schedule. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create command registration script</name>
  <files>next/scripts/deploy-commands.ts, next/package.json</files>
  <action>
Create a standalone script to register slash commands with Discord's REST API. This replaces src/deploy-commands.ts without needing discord.js.

1. **next/scripts/deploy-commands.ts** — Create a script that:
   - Loads .env.local using dotenv (already a Next.js dependency, no need to install)
   - Defines all 6 command objects as JSON (Discord API format, NOT SlashCommandBuilder):
     - registreer: name option (string, required)
     - log: uren option (number, required, min 0.1, max 24), omschrijving (string, optional), datum (string, optional)
     - wijzig: uren (number, required, min 0.5, max 24), datum (string, required), omschrijving (string, optional)
     - verwijder: datum (string, required)
     - uren: maand (string, optional)
     - email: subcommands set (with address string option), remove, show
   - Uses native fetch (Node.js 18+) to PUT to `https://discord.com/api/v10/applications/${DISCORD_APPLICATION_ID}/guilds/${GUILD_ID}/commands`
   - Authorization header: `Bot ${DISCORD_BOT_TOKEN}`
   - Logs success/failure and lists registered command names
   - Discord option types: 1=SUB_COMMAND, 3=STRING, 10=NUMBER

2. **next/package.json** — Add script: `"deploy-commands": "npx tsx scripts/deploy-commands.ts"`
   - tsx is already available via Next.js dependencies, or add as devDependency if needed

Important: Do NOT use discord.js or @discordjs/rest — use plain fetch. The script should have zero dependencies beyond Node.js built-ins and dotenv.
  </action>
  <verify>cd next && npx tsx scripts/deploy-commands.ts runs without syntax errors (will fail on missing env vars but should parse correctly). npm run build still passes.</verify>
  <done>Command registration script exists, registers all 6 commands with correct options via Discord REST API. Package.json has deploy-commands script.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd next && npm run build` succeeds without errors
- [ ] Cron route exists at next/app/api/cron/monthly-report/route.ts
- [ ] vercel.json has cron schedule for 21st of each month
- [ ] Cron route checks CRON_SECRET authorization
- [ ] Cron route calculates correct billing period (22nd to 21st)
- [ ] Cron route posts Discord notification on success/failure
- [ ] Command registration script registers all 6 commands
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Vercel Cron Job configured and route implemented
- Command registration script functional
- Phase 3 and project complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-cron-and-deployment/03-01-SUMMARY.md`
</output>
